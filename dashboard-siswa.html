<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil - SATRIA SMAGER</title><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/dashboard/global.css">
    <link rel="stylesheet" href="styles/dashboard/siswa.css">
    <link rel="stylesheet" href="styles/dashboard/daftar-card.css">
    <link rel="stylesheet" href="styles/dashboard/statis-card.css">
</head>

<body>

    <ul class="bg-squares" aria-hidden="true">
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
    </ul>

    <div class="dashboard">

        <aside class="sidebar">
            <div class="always-show-nav">
            <div class="sidebar-header">
                <div class="avatar-circle">
                    <img src="https://i.pravatar.cc/150?img=12" alt="Avatar Siswa">
                </div>
                <div class="user-info">
                    <h3>Halo, <span class="username-display"></span>!</h3>
                    <span>Siswa</span>
                </div>
            </div>

            <nav class="nav-menu">
                <button class="nav-btn active" id="go-lap">
                    Profil Siswa
                </button>
                <button class="nav-btn" id="go-stat">
                    Statistik
                </button>
                <button class="nav-btn" id="go-daf">
                    Daftar Tata Tertib
                </button>
            </nav>

            <div class="spacer"></div>
                <div class="always-show-nav-bttom">
                    <button class="nav-btn logout">
                        LOG OUT
                    </button>
                </div>
            </div>
        </aside>

        <main class="main">
            <div class="right_menu">
                <div class="menu">
                    <div class="menu_bar1"></div>
                    <div class="menu_bar2"></div>
                    <div class="menu_bar3"></div>
                </div>
            </div>
            <div class="title">Profil Saya</div>

            <section id="laporan-section" class="card">

                <div class="profile-top-section">

                    <div class="photo-container">
                        <div class="photo-frame">
                            <img src="https://i.pravatar.cc/300?img=12" alt="Foto Siswa">
                        </div>
                        <p class="nis-label">NIS: <span class="nis-display"></span></p>
                    </div>

                    <div class="data-container">
                        <div class="form-group">
                            <label>NAMA LENGKAP</label>
                            <div class="read-only-box"><span class="username-display"></span></div>
                        </div>

                        <div class="form-group">
                            <label>KELAS</label>
                            <div class="read-only-box"><span class="class-display"></span></div>
                        </div>

                        <div class="form-group">
                            <label>TOTAL POIN PELANGGARAN</label>
                            <div class="poin-box-wrapper">
                                <div class="read-only-box poin-value"><span class="skor-display"></span> / 36</div>
                                <div class="progress-bar">
                                    <div class="progress-fill"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="divider">

                <div class="profile-bottom-section">

                    <div class="status-card ">
                        <div class="icon-status"></div>
                        <div class="status-text">
                            <label>STATUS PERINGATAN</label>
                            <h3 class="status-value">AMAN</h3>
                            <p class="status-desc">Tidak Ada Peringatan</p>
                        </div>
                    </div>

                    <div class="status-card violation-type">
                        <div class="icon-status">‚ö†Ô∏è</div>
                        <div class="status-text">
                            <label>PELANGGARAN TERAKHIR</label>
                            <h3>RINGAN</h3>
                            <p>Terlambat Masuk Sekolah</p>
                        </div>
                    </div>

                </div>

            </section>
            <section id="statik-section" class="card" aria-labelledby="form-title">
                    <h2
                        id="form-title"
                        style="
                            text-align: center;
                            margin-bottom: 28px;
                            color: #111;
                            font-size: 22px;
                        ">
                        Pantau Statistik
                    </h2>
                    <div class="stats-wrapper">
                        <div class="mockup-chart-siswa"><canvas id="pieChart"></canvas></div>
                    </div>
                    <p>Analisi Bulan Ini</p>
                    
                </section>
                <section id="daf-section" class="card" aria-labelledby="form-title">
                    <h2 id="form-title" style="
                                            text-align: center;
                                            margin-bottom: 28px;
                                            color: #111;
                                            font-size: 22px;
                                        ">
                        Daftar Pelanggaran
                    </h2>
                    <div class="violation-table-container">
                    
                        <div class="category-tabs">
                            <button class="tab-btn active" onclick="filterTable('all')">Semua</button>
                            <button class="tab-btn" onclick="filterTable('kedisiplinan')">Kerajinan (J)</button>
                            <button class="tab-btn" onclick="filterTable('kebersihan')">Kerapian (P)</button>
                            <button class="tab-btn" onclick="filterTable('ketertiban')">Ketertiban (K)</button>
                            <button class="tab-btn" onclick="filterTable('berat')">Pelanggaran Berat</button>
                        </div>
                    
                        <div class="table-responsive">
                            <table class="modern-table" id="violationTable">
                                <thead>
                                    <tr>
                                        <th width="80px">Kode</th>
                                        <th>Jenis Pelanggaran</th>
                                        <th width="150px">Kategori</th>
                                        <th width="80px" class="text-center">Poin</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <a href="./dashboard-pelanggaran.html">Lihat Jenis Pelanggaran</a>
                </section>

        </main>
    </div>
    <script src="./program/database/pelanggaran.js"></script>
    <script src="program/scroll-section.js"></script>
    <script src="./program/database/keterangan.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const user = JSON.parse(sessionStorage.getItem("loggedUser"));
            const pelDB = typeof pelanggaran !== "undefined"
                ? pelanggaran
                : JSON.parse(localStorage.getItem("pelanggaranDB")) || [];


            if (!user || !user.pelanggaran) {
                location.assign("../index.html");
                return;
            }

            let weeklyPoints = [0, 0, 0, 0];

            const now = new Date();
            const month = now.getMonth() + 1; // bulan ini
            const year = now.getFullYear();

            // Hitung data per minggu
            user.pelanggaran.forEach((log) => {
                const match = pelDB.find((p) => p.code === log.code);
                if (!match) return;

                let poin = match.poin;
                let tanggal = log.time; // format: dd/mm/yyyy

                if (!tanggal) return;

                const [dd, mm, yyyy] = tanggal.split("/").map(Number);

                // Pelanggaran hanya dihitung jika bulan ini
                if (mm !== month || yyyy !== year) return;

                let dateObj = new Date(yyyy, mm - 1, dd);
                let weekNumber = Math.ceil(dateObj.getDate() / 7);

                // Pastikan minggu valid
                if (weekNumber < 1 || weekNumber > 4) return;

                weeklyPoints[weekNumber - 1] += poin;
            });

            // Jika semua nol ‚Üí kasih nilai default
            if (weeklyPoints.every((v) => v === 0)) {
                weeklyPoints = [0, 0, 0, 0];
            }

            // Render Chart
            new Chart(document.getElementById("pieChart"), {
                type: "bar",
                data: {
                    labels: ["Minggu 1", "Minggu 2", "Minggu 3", "Minggu 4"],
                    datasets: [{
                        data: weeklyPoints,
                        backgroundColor: ["#FFE5B4", "#A7E6FF", "#C9F4C4", "#FFF4A3"],
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        


            document.querySelectorAll(".username-display").forEach(a => {
                a.textContent = user.name;
            });

            
            document.querySelectorAll(".nis-display").forEach(b => {
                b.textContent = user.username;
            });

            document.querySelectorAll(".class-display").forEach(c => {
                c.textContent = user.clas;
            });

            document.querySelectorAll(".skor-display").forEach(d => {
                d.textContent = user.skor;
                document.querySelector(".progress-fill").style.width = `${(user.skor / 36) * 100}%`;
            });

            if(user.skor >= 2 && user.skor <= 5 ) {
                document.querySelector(".status-value").textContent = keterangan.p.value;
                document.querySelector(".status-desc").textContent = keterangan.p.desc;
                document.querySelector(".icon-status").textContent = "üì¢";
                document.querySelector(".status-card").classList.add("warning-status");
            } else if (user.skor >= 6 && user.skor <= 10) {
                document.querySelector(".status-value").textContent = keterangan.spt1.value;
                document.querySelector(".status-desc").textContent = keterangan.spt1.desc;
                document.querySelector(".icon-status").textContent = "üì¢";
                document.querySelector(".status-card").classList.add("warning-status");
            } else if(user.skor >= 11 && user.skor <= 15 ) {
                document.querySelector(".status-value").textContent = keterangan.spt2.value;
                document.querySelector(".status-desc").textContent = keterangan.spt2.desc;
                document.querySelector(".icon-status").textContent = "üì¢";
                document.querySelector(".status-card").classList.add("warning-status");
            } else if(user.skor >= 16 && user.skor <= 20 ) {
                document.querySelector(".status-value").textContent = keterangan.spt3.value;
                document.querySelector(".status-desc").textContent = keterangan.spt3.desc;
                document.querySelector(".icon-status").textContent = "üì¢";
                document.querySelector(".status-card").classList.add("warning-status");
            } else if(user.skor >= 21 && user.skor <= 25 ) {
                document.querySelector(".status-value").textContent = keterangan.sp1.value;
                document.querySelector(".status-desc").textContent = keterangan.sp1.desc;
                document.querySelector(".icon-status").textContent = "üì¢";
                document.querySelector(".status-card").classList.add("warning-status");
            } else if(user.skor >= 26 && user.skor <= 35 ) {
                document.querySelector(".status-value").textContent = keterangan.sp2.value;
                document.querySelector(".status-desc").textContent = keterangan.sp2.desc;
                document.querySelector(".icon-status").textContent = "üì¢";
                document.querySelector(".status-card").classList.add("warning-status");
            } else if(user.skor >= 36 ) {
                document.querySelector(".status-value").textContent = keterangan.out.value;
                document.querySelector(".status-desc").textContent = keterangan.out.desc;
                document.querySelector(".icon-status").textContent = "‚ùå";
                document.querySelector(".status-card").classList.add("warning-status");
            } else {
                document.querySelector(".status-value").textContent = keterangan.aman.value;
                document.querySelector(".status-desc").textContent = keterangan.aman.desc;
                document.querySelector(".icon-status").textContent = "‚úÖ";
            }
        

        const menu = document.querySelector('.menu');
        const sidebar = document.querySelector(".sidebar");
        const main = document.querySelector(".main");
        
        menu.addEventListener('click', () => {
            sidebar.classList.toggle("active");
            main.classList.toggle("shift");
            menu.classList.toggle('change');
        });

        document.querySelector(".nav-btn.logout").addEventListener("click", () => {
            localStorage.removeItem("currentUser");
            sessionStorage.removeItem("currentUser");
            document.cookie = "currentUser=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            window.location.href = "index.html";
        });

        const tableBody = document.querySelector("#violationTable tbody");

        if (!user.pelanggaran) {
            tableBody.innerHTML = "<tr><td colspan='4'>Tidak ada pelanggaran.</td></tr>";
        }

        function renderTable(data, container) {
            container.innerHTML = ""; // Bersihkan isi tabel hardcoded (jika ada)

            data.forEach((item) => {
                // 1. Tentukan Style & Kategori berdasarkan Kode/Poin
                const style = getStyleByCode(item.code, item.poin);

                // 2. Buat Elemen Baris (Row)
                const tr = document.createElement("tr");
                tr.className = "row-item";
                tr.setAttribute("data-category", style.filterKey); // Untuk fungsi filter

                // 3. Isi HTML Baris (Sesuai desain di dashboard_cek_pelanggaran.html)
                tr.innerHTML = `
        <td>
            <span class="badge ${style.badgeColor
                    }">${item.code.toUpperCase()}</span>
        </td>
        <td class="violation-desc ${style.textAlert}">
            ${item.jenis}
        </td>
        <td>
            <span class="cat-pill ${style.pillColor}">${style.categoryName
                    }</span>
        </td>
        <td class="text-center ${style.pointClass}">
            ${item.poin}
        </td>
    `;

                container.appendChild(tr);
            });
        }

            function getStyleByCode(codeStr, poin) {
                const code = codeStr.toLowerCase();

                // Logika Khusus: Pelanggaran Berat (Poin >= 20)
                if (poin >= 20) {
                    return {
                        filterKey: "berat",
                        categoryName: "Berat",
                        badgeColor: "code-red", // CSS class dari file anda
                        pillColor: "red", // CSS class
                        pointClass: "point-alert",
                        textAlert: "high-alert", // Membuat teks merah tebal
                    };
                }

                // Logika Umum berdasarkan awalan kode
                if (code.startsWith("j")) {
                    return {
                        filterKey: "kedisiplinan",
                        categoryName: "Kedisiplinan",
                        badgeColor: "code-blue",
                        pillColor: "blue",
                        pointClass: "point-text",
                        textAlert: "",
                    };
                } else if (code.startsWith("p")) {
                    return {
                        filterKey: "kebersihan", // Atau kerapian sesuai kebutuhan
                        categoryName: "Kerapian",
                        badgeColor: "code-green",
                        pillColor: "green",
                        pointClass: "point-text",
                        textAlert: "",
                    };
                } else {
                    // Default (K dan lainnya)
                    return {
                        filterKey: "ketertiban",
                        categoryName: "Ketertiban",
                        badgeColor: "code-orange",
                        pillColor: "orange",
                        pointClass: "point-text",
                        textAlert: "",
                    };
                }
            }


        const userViolationList = user.pelanggaran
            .map((v) => {
                const match = pelDB.find((p) => p.code === v.code);

                if (!match) return null;

                return {
                    code: match.code,
                    jenis: match.jenis,
                    poin: match.poin,
                    time: v.time,
                };
            })
            .filter((v) => v !== null);

        renderTable(userViolationList, tableBody);

        function filterTable(category) {
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            const rows = document.querySelectorAll('.row-item');
            
            rows.forEach(row => {
                if (category === 'all') {
                    row.style.display = ''; 
                } else {
                    if (row.getAttribute('data-category') === category) {
                        row.style.display = ''; 
                    } else {
                        row.style.display = 'none'; 
                    }
                }
            });
        }
        });
    </script>
</body>


</html>
